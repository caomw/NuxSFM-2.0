# vim: set ts=2 sw=2 et:
# $Id:.
# NuxSFM Maintainer : Pierre-Yves Paranthoen <nuxsfm at you know what gmail dot com>

pkgbase=('openMVS')
pkgname=('openMVS')
pkgver=v0.8
pkgrel=1.1
pkgdesc="open Multiple View Geometry library for computer-vision. Version Paracheirodon simulans"
arch=('x86_64')
url="http://imagine.enpc.fr/~moulonp/openMVS/"
groups=('computer-vision' 'sfm')
license=('MPL 2.0')
depends=('eigen' 'opencv' 'ceres-solver' 'cgal' 'boost-libs')
optdepends=('openMVG')
makedepends=('eigen' 'opencv' 'ceres-solver' 'cgal' 'google-breakpad' 'boost' 'git' 'subversion' 'openMVG-devel')
provides=('openMVS')
conflicts=('openMVS')
replaces=('openMVS')

# The git repo is detected by the 'git:' or 'git+' beginning. The branch
# '$pkgname' is then checked out upon cloning, expediating versioning:
source=("$pkgname"::'git+https://github.com/cdcseacave/openMVS.git'
	'VCGLib.patch')

# Because the sources are not static, skip Git checksum:
md5sums=('SKIP'
	'237c454f539a310fdae7b843fa3a6495')

prepare() {
    cd "$srcdir/$pkgname"
    git submodule init
    git submodule update
    
    # Get VCGLib
    cd $srcdir
    svn checkout svn://svn.code.sf.net/p/vcg/code/trunk/vcglib vcglib
    cd $srcdir/vcglib
#    patch -Np0 -i $srcdir/VCGLib.patch
}

build() {
    unset CPPFLAGS
    unset CFLAGS
    unset CXXFLAGS
    unset LDFLAGS
    
#    export CC=/usr/bin/gcc-4.9
#    export CXX=/usr/bin/g++-4.9
#    export CPP=/usr/bin/cpp-4.9
#    export LD=/usr/bin/gcc-4.9
    
    cd "$srcdir/$pkgname"
    mkdir -pv openMVS_Build
    cd openMVS_Build
    
    pwd
    echo "toto"
    
    cmake -DCMAKE_BUILD_TYPE=Release -DVCG_DIR="$srcdir/vcglib" \
	    -DCERES_DIR="/usr/local/share/Ceres" \
	    -DOpenCV_CAN_BREAK_BINARY_COMPATIBILITY=OFF . ..
#	    -DOpenCV_INCLUDE_DIR
    make
}

package() {
    cd "$srcdir/$pkgname/src/build"        

    # licence
    install -m755 -d "${pkgdir}/usr/share/licenses/${pkgname}"
}

